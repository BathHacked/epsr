var resetMap,handleData=function(){d3.csv("data/epsr.csv",function(e,t){dc.dateFormat=d3.time.format("%d/%m/%Y");var o=d3.time.format("%d/%m/%Y %H:%M:%S %p");t.forEach(function(e){e.received=o.parse(e.receiveddate),e.receivedWeek=e.received?d3.time.week(e.received):null,e.closed=o.parse(e.closeddate),e.closedWeek=e.closed?d3.time.week(e.closed):null,e.weeks=e.closed&&e.received?1+Math.floor(Math.abs(moment(e.closed).diff(moment(e.received),"weeks"))):null,e.hourofday=e.received?moment(e.received).format("HH"):null,e.dayofweek=e.received?moment(e.received).format("ddd"):null,e.dayofmonth=e.received?moment(e.received).format("DD"):null,e.month=e.received?moment(e.received).format("MMM"):null,e.type=e.type||"N/A",e.receivedhow=e.receivedhow||"N/A",e.receivedwhere=e.receivedwhere||"N/A",e.latlng=[e.latitude,e.longitude];var t=SunCalc.getMoonIllumination(e.received).phase;e.moon=["New Moon","First Quarter","Full Moon","Last Quarter"][Math.floor(4*t)],delete e.location,delete e.ref,delete e.receiveddate,delete e.closeddate});var r=crossfilter(t),n={},i={},a={};a.all=dc.dataCount("#chart-all").dimension(r).group(r.groupAll()).html({some:'<strong>%filter-count</strong> selected out of <strong>%total-count</strong> requests <a href="javascript:dc.filterAll(); dc.renderAll(); resetMap();"><i class="fa fa-fw fa-minus-circle"></i> View all requests</a>',all:"All records selected. Please use the graphs to apply filters."}),["kind","type","status","receivedhow","receivedwhere","hourofday","dayofweek","dayofmonth","month","moon"].forEach(function(e){n[e]=r.dimension(dc.pluck(e)),i[e]=n[e].group().reduceCount(),a[e]=dc.rowChart("#chart-"+e),a[e].width($("#chart-"+e).parent().width()).height(320).margins({top:0,right:10,bottom:30,left:10}).dimension(n[e]).group(i[e]).ordering(function(e){return-e.value}).elasticX(!0).label(function(e){return e.key+": "+e.value}).gap(3).colors(d3.scale.ordinal().range(["#B6BBC6"])).xAxis().ticks(2)}),["received","closed"].forEach(function(e){n[e]=r.dimension(dc.pluck(e+"Week")),i[e]=n[e].group().reduceCount(),a[e]=dc.lineChart("#chart-"+e),a[e].width($("#chart-"+e).parent().width()).height(150).margins({top:10,right:20,bottom:25,left:30}).dimension(n[e]).group(i[e]).renderArea(!0).mouseZoomable(!1).x(d3.time.scale().domain([new Date(2014,0,0),new Date])).elasticX(!0).xUnits(d3.time.days).round(d3.time.day.round).elasticY(!0).renderHorizontalGridLines(!0).colors(d3.scale.ordinal().range(["#2C3E50"])).xAxis().ticks(4)}),["weeks"].forEach(function(e){n[e]=r.dimension(dc.pluck(e)),i[e]=n[e].group().reduceCount(),a[e]=dc.barChart("#chart-"+e),a[e].width($("#chart-"+e).parent().width()).height(150).margins({top:10,right:20,bottom:25,left:30}).dimension(n[e]).group(i[e]).x(d3.scale.linear().domain([1,n[e].top(1)[0][e]+1])).round(dc.round.ceil).elasticY(!0).renderHorizontalGridLines(!0).colors(d3.scale.ordinal().range(["#2C3E50"])).xAxis().ticks(4)}),a.table=dc.dataTable("#chart-table").dimension(n.received).group(function(e){var t=d3.format("02d");return e.received.getFullYear()+"/"+t(e.received.getMonth()+1)}).size(100).columns([{label:"Received",format:function(e){var t=moment(e.received);return t.isValid()?t.format("DD/MM/YYYY"):""}},{label:"Closed",format:function(e){var t=moment(e.closed);return t.isValid()?t.format("DD/MM/YYYY"):""}},"days","kind","type","status",{label:"How",format:dc.pluck("receivedhow")},{label:"Where",format:dc.pluck("receivedwhere")}]).sortBy(dc.pluck("received")).order(d3.descending);var c=L.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],shadowUrl:"img/icon-shadow.png"}}),d=new c({iconUrl:"img/icon-default.png"}),l=new c({iconUrl:"img/icon-selected.png"});n.location=r.dimension(function(e){return e.latlng}),i.location=n.location.group().reduceCount();var s=[];a.location=dc_leaflet.markerChart("#chart-location"),a.location.width($("#chart-location").parent().width()).height(480).dimension(n.location).group(i.location).mapOptions({maxBounds:[[51.2719,-2.70944],[51.4397,-2.27768]],minZoom:11}).center([51.3844,-2.3642]).zoom(13).marker(function(e){var t=L.marker(e.key,{selected:!1,icon:d});return t.on("click",function(e){e.target.options.selected?(e.target.options.selected=!1,e.target.setIcon(d)):(e.target.options.selected=!0,e.target.setIcon(l))}),s.push(t),t}).renderPopup(!1).popup(function(e){return"Count: "+e.value}).cluster(!0).clusterOptions({disableClusteringAtZoom:16}).brushOn(!0).filterByArea(!1),resetMap=function(){_.each(s,function(e){e.options.selected=!1,e.setIcon(d)})},_.each(_.keys(a),function(e){$('a[href="#'+e+'"]').on("click",function(t){t.preventDefault(),a[e].filterAll(),dc.redrawAll()})}),dc.renderAll();var u=a.location.map();u.on("click",function(e){_.forEach(s,function(e){e.options.selected=!1,e.setIcon(d)})}),$(window).on("resize",function(){setTimeout(function(){_.each(_.keys(a),function(e){a[e].width($("#chart-"+e).parent().width())}),dc.redrawAll(),u.invalidateSize()},100)})})};$(function(){handleData()});